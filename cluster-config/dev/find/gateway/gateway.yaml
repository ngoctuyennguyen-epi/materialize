---

apiVersion: v1
kind: ServiceAccount
metadata:
  name: traefik-ingress-controller
  namespace: default
---

kind: Deployment
apiVersion: apps/v1
metadata:
  name: traefik-ingress-controller
  namespace: default
  labels:
    k8s-app: traefik-ingress-lb
    
spec:
  replicas: 1
  selector:
    matchLabels:
      k8s-app: traefik-ingress-lb
  template:
    metadata:
      labels:
        k8s-app: traefik-ingress-lb
        name: traefik-ingress-lb
    spec:
      serviceAccountName: traefik-ingress-controller
      terminationGracePeriodSeconds: 60
      containers:
      - image: episerver.azurecr.io/optiq-traefik-turnstile:1.0.5-alpine # Gateway image version
        name: traefik-ingress
        resources:
          limits:
            cpu: "1000m"
            memory: "1Gi"
          requests:
            cpu: "750m"
            memory: "800Mi"
        ports:
        - name: http
          containerPort: 80
          hostPort: 80
        - name: https
          containerPort: 443
          hostPort: 443
        - name: internal-http
          containerPort: 8000
          hostPort: 8000
        - name: internal-es
          containerPort: 9200
          hostPort: 9200
        securityContext:
          capabilities:
            drop:
            - ALL
            add:
            - NET_BIND_SERVICE
        envFrom:
        - secretRef:
            name: turnstile-secrets
        - secretRef:
            name: cluster-secrets
        volumeMounts:
        - name: config-volume
          mountPath: /etc/config
        lifecycle:
          postStart:
            exec:
              command: 
              - /bin/sh
              - -c
              - > 
                echo "http:
                  middlewares:
                    rate-limiter:
                      turnstileRateLimiter:
                        providerType: Redis
                        connectionOptions: addr=$REDIS_HOST_NAME:6379,db=0,password=$REDIS_ACCESS_KEY
                        limits:
                        - period: 1
                          rate: 200
                          rateClaim: QPS" > /usr/share/traefik/config/config.yaml
        args:
        - --metrics.datadog=true
        - --metrics.datadog.address=datadog-agent:8125
        - --metrics.datadog.addrouterslabels=true
        - --metrics.datadog.pushInterval=15s
        # - --tracing.datadog=true
        # - --tracing.datadog.localAgentHostPort=datadog-agent:8126
        # - --tracing.datadog.debug=true
        - --log.level=INFO
        - --log.filePath="/var/log/turnstile-gateway.log"
        - --log.format=json
        - --accesslog=true
        - --entrypoints.http.Address=:80
        - --entrypoints.http.http.redirections.entryPoint.to=:443
        - --entrypoints.https.Address=:443
        - --entrypoints.https.Turnstile.turnstileEndpoint=$(KV_TURNSTILE_ENDPOINT)
        - --entrypoints.https.Turnstile.appKey=$(KV_TURNSTILE_KEY)
        - --entrypoints.https.Turnstile.appSecret=$(KV_TURNSTILE_SECRET)
        - --entrypoints.https.Turnstile.allowedAuthenticationModes=epi-single epi-hmac
        - --entrypoints.https.Turnstile.allowRingHeader=true
        - --entrypoints.https.Turnstile.allowUpstreamAuthorization=true
        - --entrypoints.internal-http.Address=:8000
        - --entrypoints.internal-es.Address=:9200
        - --providers.kubernetescrd
        - --providers.file.filename=/usr/share/traefik/config/config.yaml
      imagePullSecrets:
      - name: acr-auth
      # volumes:
      # - name: config-volume
      #   configMap:
      #     name: cluster-ip
      #     items:
      #     - key: CLUSTER_IP
      #       path: keys
---

# Source: gateway/templates/traefik-service.yml
# Defines a load balancer that will expose the Traefik
# ingress controller externally to accept requests.
 
kind: Service
apiVersion: v1
metadata:
  name: traefik-ingress-service
  namespace: default
spec:
  selector:
    k8s-app: traefik-ingress-lb
  ports:
    - protocol: TCP
      port: 80
      name: http
    - protocol: TCP
      port: 443
      name: https
  type: LoadBalancer
  loadBalancerIP: ${CLUSTER_IP}


---

kind: Service
apiVersion: v1
metadata:
  name: traefik-ingress-service-internal
  namespace: default
spec:
  selector:
    k8s-app: traefik-ingress-lb
  ports:
    - protocol: TCP
      port: 80
      targetPort: 8000
      name: http

---

kind: Service
apiVersion: v1
metadata:
  name: traefik-ingress-service-internal-elasticsearch
  namespace: default
spec:
  selector:
    k8s-app: traefik-ingress-lb
  ports:
    - protocol: TCP
      port: 80
      targetPort: 9200
      name: http
---

# Source: gateway/templates/traefik-tls-store.yml
# Defines SSL certificates stores

apiVersion: traefik.containo.us/v1alpha1
kind: TLSStore
metadata:
  name: default
  namespace: default
spec:
  defaultCertificate:
    secretName: tls-cert-secrets

